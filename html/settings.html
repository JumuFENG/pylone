<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设置 - phoniun管理后台</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .settings-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
        }

        .search-box button {
            width: auto;
            padding: 10px 20px;
        }

        .stock-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .stock-item {
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .stock-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .stock-info {
            flex: 1;
        }

        .stock-code {
            font-weight: 600;
            color: #333;
            margin-right: 10px;
        }

        .stock-name {
            color: #666;
        }

        .btn-small {
            width: auto;
            padding: 6px 15px;
            font-size: 14px;
        }

        .btn-remove {
            background: #dc3545;
        }

        .btn-add {
            background: #28a745;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
        }

        .system-info {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            min-width: 150px;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #555;
        }

        .info-value {
            color: #333;
        }

        .system-settings {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
            min-width: 200px;
        }

        .setting-info {
            flex: 1;
        }

        .setting-key {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 4px;
        }

        .setting-description {
            font-size: 12px;
            color: #999;
        }

        .setting-value {
            color: #666;
            margin-right: 10px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        /* 开关按钮样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* 输入框样式 */
        .setting-input {
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            max-width: 200px;
        }

        .setting-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 添加设置项表单样式 */
        .add-setting-form {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group small {
            display: block;
            color: #999;
            font-size: 12px;
            margin-top: 3px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav">
            <h2>设置</h2>
            <div class="nav-links">
            </div>
        </div>

        <div id="alert" style="display: none; position: fixed; top: 100px; left: 50%; transform: translateX(-50%);"></div>
        <div style="display: flex; gap: 20px;">

            <!-- 股票管理区域 -->
            <div class="settings-section" style="width: 25%;">
                <div class="section-title">股票列表</div>

                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="输入股票代码或名称搜索..." oninput="searchStock()" />
                    <button class="btn btn-small" onclick="searchStock()">搜索</button>
                </div>

                <div id="searchResults" class="search-results d-none"></div>

                <div id="stockList" class="stock-list">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 板块管理区域 -->
            <div class="settings-section" style="width: 20%;">
                <div class="section-title">板块列表</div>

                <div class="search-box">
                    <input type="text" id="bkSearchInput" placeholder="输入板块代码或名称搜索..." />
                    <button class="btn btn-small" onclick="searchBk()">搜索</button>
                </div>

                <div id="bkList" class="stock-list">
                    <div class="loading">加载中...</div>
                </div>
            </div>

            <!-- 系统设置区域 -->
            <div class="settings-section" style="flex: 1; min-width: 350px;">
                <div class="section-title">系统信息</div>

                <div id="systemInfo" class="system-info">
                    <div class="loading">加载中...</div>
                </div>

                <div class="section-title" style="margin-top: 30px;">系统设置</div>

                <div id="systemSettings" class="system-settings">
                    <div class="loading">加载中...</div>
                </div>

                <!-- 添加新设置项按钮 -->
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-small btn-add" onclick="showAddSettingForm()">
                        + 添加新设置项
                    </button>
                </div>

                <!-- 添加设置项表单（默认隐藏） -->
                <div id="addSettingForm" class="add-setting-form" style="display: none;">
                    <div class="form-group">
                        <label>键名 (key)</label>
                        <input type="text" id="newSettingKey" placeholder="例如: max_retry_count" />
                        <small>只能包含字母、数字和下划线</small>
                    </div>
                    <div class="form-group">
                        <label>显示名称</label>
                        <input type="text" id="newSettingName" placeholder="例如: 最大重试次数" />
                    </div>
                    <div class="form-group">
                        <label>值类型</label>
                        <select id="newSettingValtype">
                            <option value="0">只读</option>
                            <option value="1">开关</option>
                            <option value="2">数值</option>
                            <option value="3" selected>字符串</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>初始值</label>
                        <input type="text" id="newSettingValue" placeholder="设置的初始值" />
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-small" onclick="hideAddSettingForm()">取消</button>
                        <button class="btn btn-small btn-add" onclick="createNewSetting()">创建</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        let allStocks = [];
        let searchResults = [];
        let allBks = [];
        let filteredBks = [];

        // 页面加载时获取用户股票列表
        async function loadAllStocks() {
            try {
                currentUser = await getCurrentUser();

                const response = await fetch('/stock/allstockinfo', {
                    credentials: 'include'
                });

                if (response.ok) {
                    allStocks = await response.json();
                    renderStockList();
                } else if (response.status === 401) {
                    window.location.href = '/html/login.html';
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                document.getElementById('stockList').innerHTML =
                    '<div class="empty-state">加载股票列表失败</div>';
            }
        }

        // 渲染股票列表
        function renderStockList() {
            const stockList = document.getElementById('stockList');

            if (allStocks.length === 0) {
                stockList.innerHTML = '<div class="empty-state">暂无股票，请搜索添加</div>';
                return;
            }

            stockList.innerHTML = allStocks.map(stock => `
                <div class="stock-item">
                    <div class="stock-info">
                        <span class="stock-code">${stock.code}</span>
                        <span class="stock-name">${stock.name || '未知'}</span>
                        <span class="stock-code">${stock.typekind || '未知'}</span>
                    </div>
                    <div class="hover-actions">
                        <button class="btn btn-small btn-remove" onclick="removeStock('${stock.code}')">
                            移除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 搜索股票
        async function searchStock() {
            const keyword = document.getElementById('searchInput').value.trim();
            if (!keyword || keyword.length < 3) {
                return;
            }

            try {
                const response = await fetch(`/admin/search?keyword=${encodeURIComponent(keyword)}`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    searchResults = await response.json();
                    renderSearchResults();
                } else {
                    throw new Error('搜索失败');
                }
            } catch (error) {
                console.error(error);
            }
        }

        // 渲染搜索结果
        function renderSearchResults() {
            const searchResultsList = document.getElementById('searchResults');

            if (searchResults.length === 0) {
                searchResultsList.innerHTML = '<div class="empty-state">未找到相关股票</div>';
                searchResultsList.classList.remove('d-none');
                return;
            }

            searchResultsList.innerHTML = searchResults.map(stock => {
                const isAdded = allStocks.some(s => s.code === stock.code);
                return `
                    <div class="stock-item">
                        <div class="stock-info">
                            <span class="stock-code">${stock.code}</span>
                            <span class="stock-name">${stock.name}</span>
                            <span class="stock-code">${stock.typekind}</span>
                        </div>
                        <div class="hover-actions">
                            ${isAdded ?
                                '<span style="color: #28a745;">已添加</span>' :
                                `<button class="btn btn-small btn-add" onclick="addStock('${stock.code}')">添加</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            searchResultsList.classList.remove('d-none');
            searchResultsList.onkeydown = function(e) {
                if (e.key === 'Escape') {
                    searchResultsList.classList.add('d-none');
                }
            };
        }

        // 添加股票
        async function addStock(code, name) {
            try {
                const searchedStock = searchResults.find(s => s.code === code);
                if (!searchedStock) {
                    throw new Error('股票未找到');
                }
                const response = await fetch('/admin/addstock', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(searchedStock)
                });

                if (response.ok) {
                    showSuccess('添加成功');
                    loadAllStocks();
                    document.getElementById('searchResults').classList.add('d-none');
                    document.getElementById('searchInput').value = '';
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '添加失败');
                }
            } catch (error) {
                showError('添加失败：' + error.message);
            }
        }

        // 移除股票
        async function removeStock(code) {
            if (!confirm('确定要移除这只股票吗？')) {
                return;
            }

            try {
                const response = await fetch('/admin/removestock', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code
                    })
                });

                if (response.ok) {
                    showSuccess('移除成功');
                    loadAllStocks();
                } else {
                    throw new Error('移除失败');
                }
            } catch (error) {
                showError('移除失败，请重试');
            }
        }

        // 加载所有板块
        async function loadAllBks() {
            try {
                const response = await fetch('/api/allbks', {
                    credentials: 'include'
                });

                if (response.ok) {
                    allBks = await response.json();
                    filteredBks = allBks;
                    renderBkList();
                } else if (response.status === 401) {
                    window.location.href = '/html/login.html';
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                document.getElementById('bkList').innerHTML =
                    '<div class="empty-state">加载板块列表失败</div>';
            }
        }

        // 渲染板块列表
        function renderBkList() {
            const bkList = document.getElementById('bkList');

            if (filteredBks.length === 0) {
                bkList.innerHTML = '<div class="empty-state">暂无板块数据</div>';
                return;
            }

            filteredBks.sort((bk1, bk2) => bk1.chgignore - bk2.chgignore);
            bkList.innerHTML = filteredBks.map(bk => `
                <div class="stock-item">
                    <div class="stock-info">
                        <span class="stock-code">${bk.code}</span>
                        <span class="stock-name">${bk.name || '未知'}</span>
                    </div>
                    <div class="hover-actions">
                        <button class="btn btn-small ${bk.chgignore ? 'btn-add' : 'btn-remove'}"
                                onclick="toggleBkIgnore('${bk.code}', ${bk.chgignore ? 1 : 0})">
                            ${bk.chgignore ? '启用' : '忽略'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 搜索板块
        function searchBk() {
            const keyword = document.getElementById('bkSearchInput').value.trim().toLowerCase();

            if (!keyword) {
                filteredBks = allBks;
            } else {
                filteredBks = allBks.filter(bk =>
                    bk.code.toLowerCase().includes(keyword) ||
                    (bk.name && bk.name.includes(keyword))
                );
            }

            renderBkList();
        }

        // 切换板块忽略状态
        async function toggleBkIgnore(code, currentIgnore) {
            const newIgnore = currentIgnore ? 0 : 1;
            const action = newIgnore ? '忽略' : '启用';

            try {
                const response = await fetch('/admin/ignore_bk', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        ignore: newIgnore
                    })
                });

                if (response.ok) {
                    showSuccess(`${action}成功`);
                    // 更新本地数据
                    const bk = allBks.find(b => b.code === code);
                    if (bk) {
                        bk.chgignore = newIgnore;
                    }
                    searchBk(); // 重新渲染
                } else {
                    throw new Error(`${action}失败`);
                }
            } catch (error) {
                showError(`${action}失败，请重试`);
            }
        }

        // 加载系统信息
        async function loadSystemInfo() {
            try {
                const response = await fetch('/admin/system_info', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const info = await response.json();
                    renderSystemInfo(info);
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                document.getElementById('systemInfo').innerHTML =
                    '<div class="empty-state">加载系统信息失败</div>';
            }
        }

        // 渲染系统信息
        function renderSystemInfo(info) {
            const formatBytes = (bytes) => {
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let size = bytes;
                let unitIndex = 0;
                while (size >= 1024 && unitIndex < units.length - 1) {
                    size /= 1024;
                    unitIndex++;
                }
                return `${size.toFixed(2)} ${units[unitIndex]}`;
            };

            const systemInfoDiv = document.getElementById('systemInfo');

            let html = `
                <div class="info-item">
                    <span class="info-label">应用名称</span>
                    <span class="info-value">${info.app_name || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">版本</span>
                    <span class="info-value">${info.system_version || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">操作系统</span>
                    <span class="info-value">${info.platform || 'N/A'}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Python版本</span>
                    <span class="info-value">${info.python_version || 'N/A'}</span>
                </div>
            `;

            if (info.cpu_count) {
                html += `
                    <div class="info-item">
                        <span class="info-label">CPU核心数</span>
                        <span class="info-value">${info.cpu_count}</span>
                    </div>
                    <div>
                        <div class="info-item">
                            <span class="info-label">CPU使用率</span>
                            <span class="info-value">${info.cpu_percent}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${info.cpu_percent > 80 ? 'warning' : ''}"
                                style="width: ${info.cpu_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            if (info.memory_total) {
                html += `
                    <div>
                        <div class="info-item">
                            <span class="info-label">内存</span>
                            <span class="info-value">${formatBytes(info.memory_available)} / ${formatBytes(info.memory_total)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${info.memory_percent > 80 ? 'warning' : ''}"
                                style="width: ${info.memory_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            if (info.disk_total) {
                html += `
                    <div>
                        <div class="info-item">
                            <span class="info-label">磁盘</span>
                            <span class="info-value">${formatBytes(info.disk_total - info.disk_used)} / ${formatBytes(info.disk_total)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${info.disk_percent > 80 ? 'warning' : ''}"
                                style="width: ${info.disk_percent}%"></div>
                        </div>
                    </div>
                `;
            }

            systemInfoDiv.innerHTML = html;
        }

        // 加载系统设置
        async function loadSystemSettings() {
            try {
                const response = await fetch('/admin/system_settings', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const settings = await response.json();
                    renderSystemSettings(settings);
                } else {
                    throw new Error('加载失败');
                }
            } catch (error) {
                document.getElementById('systemSettings').innerHTML =
                    '<div class="empty-state">加载系统设置失败</div>';
            }
        }

        // 渲染系统设置
        function renderSystemSettings(settings) {
            const systemSettingsDiv = document.getElementById('systemSettings');

            if (settings.length === 0) {
                systemSettingsDiv.innerHTML = '<div class="empty-state">暂无系统设置</div>';
                return;
            }

            systemSettingsDiv.innerHTML = settings.map(setting => {
                let valueDisplay = '';

                if (!setting.editable) {
                    // 只读项
                    valueDisplay = `<span class="setting-value" title="${setting.value}">${setting.value || '(空)'}</span>`;
                } else if (setting.valtype === 1) {
                    // 开关量
                    const checked = setting.value === '1' ? 'checked' : '';
                    valueDisplay = `
                        <label class="switch">
                            <input type="checkbox" ${checked} onchange="updateSetting('${setting.key}', this.checked ? '1' : '0')">
                            <span class="slider"></span>
                        </label>
                    `;
                } else if (setting.valtype === 2) {
                    // 数值量
                    valueDisplay = `
                        <input type="number" class="setting-input" value="${setting.value}"
                               onchange="updateSetting('${setting.key}', this.value)">
                    `;
                } else if (setting.valtype === 3) {
                    // 字符串量
                    valueDisplay = `
                        <input type="text" class="setting-input" value="${setting.value}"
                               onchange="updateSetting('${setting.key}', this.value)">
                    `;
                }

                return `
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-key">${setting.name}</span>
                            <span class="setting-description">${setting.key} (${setting.valtype_name})</span>
                        </div>
                        ${valueDisplay}
                    </div>
                `;
            }).join('');
        }

        // 更新设置项
        async function updateSetting(key, value) {
            try {
                const response = await fetch('/admin/system_settings', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ key, value })
                });

                if (response.ok) {
                    showSuccess('设置已更新');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '更新失败');
                }
            } catch (error) {
                showError('更新失败：' + error.message);
                // 重新加载设置以恢复原值
                loadSystemSettings();
            }
        }

        // 显示添加设置项表单
        function showAddSettingForm() {
            document.getElementById('addSettingForm').style.display = 'block';
            // 清空表单
            document.getElementById('newSettingKey').value = '';
            document.getElementById('newSettingName').value = '';
            document.getElementById('newSettingValue').value = '';
            document.getElementById('newSettingValtype').value = '3';
        }

        // 隐藏添加设置项表单
        function hideAddSettingForm() {
            document.getElementById('addSettingForm').style.display = 'none';
        }

        // 创建新设置项
        async function createNewSetting() {
            const key = document.getElementById('newSettingKey').value.trim();
            const name = document.getElementById('newSettingName').value.trim();
            const value = document.getElementById('newSettingValue').value.trim();
            const valtype = parseInt(document.getElementById('newSettingValtype').value);

            // 验证输入
            if (!key) {
                showError('请输入键名');
                return;
            }

            // 验证key格式（只能包含字母、数字和下划线）
            if (!/^[a-zA-Z0-9_]+$/.test(key)) {
                showError('键名只能包含字母、数字和下划线');
                return;
            }

            if (!name) {
                showError('请输入显示名称');
                return;
            }

            if (!value) {
                showError('请输入初始值');
                return;
            }

            // 根据类型验证值
            if (valtype === 1) { // 开关
                if (!['0', '1', 'true', 'false'].includes(value.toLowerCase())) {
                    showError('开关量的值必须是 0、1、true 或 false');
                    return;
                }
            } else if (valtype === 2) { // 数值
                if (isNaN(value)) {
                    showError('数值量的值必须是数字');
                    return;
                }
            }

            try {
                const response = await fetch('/admin/system_settings/create', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ key, name, value, valtype })
                });

                if (response.ok) {
                    showSuccess('设置项已创建');
                    hideAddSettingForm();
                    loadSystemSettings(); // 重新加载设置列表
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '创建失败');
                }
            } catch (error) {
                showError('创建失败：' + error.message);
            }
        }

        // 支持回车搜索
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });

            document.getElementById('bkSearchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBk();
                }
            });

            document.getElementById('bkSearchInput').addEventListener('input', function(e) {
                searchBk();
            });

            loadAllStocks();
            loadAllBks();
            loadSystemInfo();
            loadSystemSettings();
        });
        common.init_nav_links();
    </script>
</body>
</html>
