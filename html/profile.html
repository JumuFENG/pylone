<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - 用户管理系统</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <div class="nav">
            <h2>个人信息</h2>
            <div class="nav-links">
                <a href="#" id="adminLink" style="display: none;">用户管理</a>
                <a href="#" onclick="logout()">退出登录</a>
            </div>
        </div>
        
        <div id="alert" style="display: none; position: fixed; top: 100px; left: 50%; transform: translateX(-50%);"></div>
        
        <div id="loading" class="loading">加载中...</div>
        
        <div id="userInfo" style="display: none;">
            <div class="nav-links hover-actions" style="display: flex;flex-direction: row-reverse;">
                <a id="editBtn" href="#" onclick="toggleEdit()">编辑</a>
                <a id="saveBtn" href="#" style="display: none;" onclick="saveChanges()">保存</a>
                <a id="cancelBtn" href="#" style="color: #aaa; display: none;" onclick="cancelEdit()">取消</a>
            </div>
            
            <div class="user-info">
                <p class="d-flex"><strong>用户ID:</strong> <span id="userId" style="width: 250px;"></span></p>
                <p class="d-flex">
                    <strong>邮箱:</strong> 
                    <span id="userEmailDisplay" style="width: 250px;"></span>
                    <input type="email" id="userEmailInput" style="display: none; width: 250px;">
                </p>
                <p class="d-flex">
                    <strong>用户名:</strong> 
                    <span id="userNameDisplay" style="width: 250px;"></span>
                    <input type="text" id="userNameInput" style="display: none; width: 250px;">
                </p>
                <p id="passwordRow" class="d-flex" style="display: none;">
                    <strong>新密码:</strong>
                    <input type="password" id="userPasswordInput" placeholder="至少6位,留空则不修改" minlength="6" style="width: 250px;">
                </p>
                <p><strong>账号状态:</strong> <span id="userActive"></span></p>
                <p><strong>邮箱验证:</strong> <span id="userVerified"></span></p>
                <p><strong>管理员权限:</strong> <span id="userSuperuser"></span></p>
            </div>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        let currentUser = null;
        let isEditing = false;

        async function loadUserInfo() {
            try {
                currentUser = await getCurrentUser();
                
                document.getElementById('userId').textContent = currentUser.id;
                document.getElementById('userEmailDisplay').textContent = currentUser.email;
                document.getElementById('userEmailInput').value = currentUser.email;
                document.getElementById('userNameDisplay').textContent = currentUser.username || '未设置';
                document.getElementById('userNameInput').value = currentUser.username || '';
                document.getElementById('userActive').innerHTML = currentUser.is_active 
                    ? '<span class="badge badge-success">激活</span>' 
                    : '<span class="badge badge-danger">未激活</span>';
                document.getElementById('userVerified').innerHTML = currentUser.is_verified 
                    ? '<span class="badge badge-success">已验证</span>' 
                    : '<span class="badge badge-warning">未验证</span>';
                document.getElementById('userSuperuser').innerHTML = currentUser.is_superuser 
                    ? '<span class="badge badge-success">是</span>' 
                    : '<span class="badge badge-danger">否</span>';
                
                // 如果是管理员，显示用户管理链接
                if (currentUser.is_superuser) {
                    const adminLink = document.getElementById('adminLink');
                    adminLink.style.display = 'inline';
                    adminLink.href = '/admin.html';
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('userInfo').style.display = 'block';
            } catch (error) {
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function toggleEdit() {
            isEditing = true;
            
            // 切换按钮显示
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'inline-block';
            document.getElementById('cancelBtn').style.display = 'inline-block';
            
            // 切换显示/输入模式
            document.getElementById('userEmailDisplay').style.display = 'none';
            document.getElementById('userEmailInput').style.display = 'inline-block';
            document.getElementById('userNameDisplay').style.display = 'none';
            document.getElementById('userNameInput').style.display = 'inline-block';
            document.getElementById('passwordRow').style.display = 'flex';
        }

        function cancelEdit() {
            isEditing = false;
            
            // 切换按钮显示
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            
            // 恢复原始值
            document.getElementById('userEmailInput').value = currentUser.email;
            document.getElementById('userNameInput').value = currentUser.username || '';
            document.getElementById('userPasswordInput').value = '';
            
            // 切换显示/输入模式
            document.getElementById('userEmailDisplay').style.display = 'inline';
            document.getElementById('userEmailInput').style.display = 'none';
            document.getElementById('userNameDisplay').style.display = 'inline';
            document.getElementById('userNameInput').style.display = 'none';
            document.getElementById('passwordRow').style.display = 'none';
        }

        async function saveChanges() {
            const newEmail = document.getElementById('userEmailInput').value;
            const newUsername = document.getElementById('userNameInput').value;
            const newPassword = document.getElementById('userPasswordInput').value;
            
            const updateData = {};
            if (newEmail && newEmail !== currentUser.email) updateData.email = newEmail;
            if (newUsername && newUsername !== currentUser.username) updateData.username = newUsername;
            if (newPassword) {
                if (newPassword.length < 6) {
                    showError('密码长度至少为6位');
                    return;
                }
                updateData.password = newPassword;
            }
            
            if (Object.keys(updateData).length === 0) {
                showError('没有修改任何信息');
                cancelEdit();
                return;
            }
            
            try {
                await updateUser(currentUser.id, updateData);
                showSuccess('更新成功！');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } catch (error) {
                showError(error.message);
            }
        }

        loadUserInfo();
    </script>
</body>
</html>
