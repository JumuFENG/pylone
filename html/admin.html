<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 管理员</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container wide">
        <div class="nav">
            <h2>用户管理</h2>
            <div class="nav-links">
                <a href="/profile.html">个人信息</a>
                <a href="#" onclick="logout()">退出登录</a>
            </div>
        </div>
        
        <div id="alert" style="display: none;"></div>
        
        <div id="loading" class="loading">加载中...</div>
        
        <div id="userList" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>邮箱</th>
                        <th>用户名</th>
                        <th>状态</th>
                        <th>验证</th>
                        <th>管理员</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        async function checkAdminAccess() {
            try {
                const user = await getCurrentUser();
                if (!user.is_superuser) {
                    showError('您没有管理员权限');
                    setTimeout(() => {
                        window.location.href = '/profile.html';
                    }, 2000);
                    return false;
                }
                return true;
            } catch (error) {
                showError(error.message);
                return false;
            }
        }

        async function loadUsers() {
            try {
                const users = await getAllUsers();
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const isSuperAdmin = user.id === 1; // ID 为 1 的是超级管理员，受保护
                    
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.username || '-'}</td>
                        <td>${user.is_active ? '<span class="badge badge-success">激活</span>' : '<span class="badge badge-danger">未激活</span>'}</td>
                        <td>${user.is_verified ? '<span class="badge badge-success">已验证</span>' : '<span class="badge badge-warning">未验证</span>'}</td>
                        <td>${user.is_superuser ? '<span class="badge badge-success">是</span>' : '<span class="badge badge-danger">否</span>'}</td>
                        <td>
                            ${isSuperAdmin ? '<span style="color: #999;">受保护的超级管理员</span>' : `
                                <button class="action-btn action-btn-edit" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                    ${user.is_active ? '禁用' : '启用'}
                                </button>
                                <button class="action-btn action-btn-edit" onclick="toggleSuperuser(${user.id}, ${!user.is_superuser})">
                                    ${user.is_superuser ? '取消管理员' : '设为管理员'}
                                </button>
                                <button class="action-btn action-btn-delete" onclick="confirmDelete(${user.id}, '${user.email}')">删除</button>
                            `}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('userList').style.display = 'block';
            } catch (error) {
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                await updateUser(userId, { is_active: newStatus });
                showSuccess('用户状态已更新');
                setTimeout(() => loadUsers(), 1000);
            } catch (error) {
                showError(error.message);
            }
        }

        async function toggleSuperuser(userId, newStatus) {
            try {
                await updateUser(userId, { is_superuser: newStatus });
                showSuccess('管理员权限已更新');
                setTimeout(() => loadUsers(), 1000);
            } catch (error) {
                showError(error.message);
            }
        }

        async function confirmDelete(userId, email) {
            if (confirm(`确定要删除用户 ${email} 吗？此操作不可恢复！`)) {
                try {
                    await deleteUser(userId);
                    showSuccess('用户已删除');
                    setTimeout(() => loadUsers(), 1000);
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        async function init() {
            const isAdmin = await checkAdminAccess();
            if (isAdmin) {
                await loadUsers();
            }
        }

        init();
    </script>
</body>
</html>
