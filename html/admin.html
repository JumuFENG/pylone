<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - 管理员</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container wide">
        <div class="nav">
            <h2>用户管理</h2>
            <div class="nav-links">
                <a href="/profile.html">个人信息</a>
                <a href="#" onclick="logout()">退出登录</a>
            </div>
        </div>

        <div id="alert" style="display: none; position: fixed; top: 100px; left: 50%; transform: translateX(-50%);"></div>

        <div id="loading" class="loading">加载中...</div>

        <div id="userList" style="display: none;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>状态</th>
                        <th>验证</th>
                        <th>管理员</th>
                        <th>实盘</th>
                        <th>主账户</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                </tbody>
            </table>

            <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0;">
                <h3>创建新用户</h3>
                <form id="createUserForm">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="display: flex;">
                            <label for="newUserUsername">用户名 *</label>
                            <input type="text" id="newUserUsername" name="username" required style="width: 60%;height: 30px;">
                        </div>
                        <div style="display: flex;">
                            <label for="newUserEmail">邮箱 *</label>
                            <input type="email" id="newUserEmail" name="email" required style="width: 60%;height: 30px;">
                        </div>
                        <div style="display: flex;">
                            <label for="newUserPassword">密码 * <small style="color: #666;">(至少6位)</small></label>
                            <input type="password" id="newUserPassword" name="password" required minlength="6" style="width: 60%;height: 30px;">
                        </div>
                    </div>
                    <div style="display: flex;">
                        <div style="display: flex; gap: 35px; align-items: center; margin-bottom: 15px;width: 86%;">
                            <label style="margin: 0;">
                                <input type="checkbox" id="newUserIsActive" name="is_active" checked>
                                激活账户
                            </label>
                            <label style="margin: 0;">
                                <input type="checkbox" id="newUserIsVerified" name="is_verified">
                                邮箱已验证
                            </label>
                            <label style="margin: 0;">
                                <input type="checkbox" id="newUserIsSuperuser" name="is_superuser">
                                管理员权限
                            </label>
                            <label style="margin: 0;">
                                资金类型
                                <select name="realcash" id="newUserRealcash" style="width: auto;">
                                    <option value="1" selected>实盘</option>
                                    <option value="0" >模拟盘</option>
                                </select>
                            </label>
                            <label style="margin: 0;">
                                选择父账户
                                <select name="parent" id="newUserParent" style="width: auto;">
                                    <option value="" selected>无</option>
                                </select>
                            </label>
                        </div>
                        <div>
                            <button type="submit" class="action-btn action-btn-edit">创建用户</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>""

    <script src="/static/js/auth.js"></script>
    <script>
        async function checkAdminAccess() {
            try {
                const user = await getCurrentUser();
                if (!user.is_superuser) {
                    showError('您没有管理员权限');
                    setTimeout(() => {
                        window.location.href = '/profile.html';
                    }, 2000);
                    return false;
                }
                return true;
            } catch (error) {
                showError(error.message);
                return false;
            }
        }

        async function loadUsers() {
            try {
                const users = await getAllUsers();
                const tbody = document.getElementById('userTableBody');
                const parentSelect = document.getElementById('newUserParent');
                tbody.innerHTML = '';
                while (parentSelect.options.length > 1) {
                    parentSelect.remove(1);
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    const isSuperAdmin = user.id === 1; // ID 为 1 的是超级管理员，受保护

                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username || '-'}</td>
                        <td>${user.email}</td>
                        <td>${user.is_active ? '<span class="badge badge-success">激活</span>' : '<span class="badge badge-danger">未激活</span>'}</td>
                        <td>${user.is_verified ? '<span class="badge badge-success">已验证</span>' : '<span class="badge badge-warning">未验证</span>'}</td>
                        <td>${user.is_superuser ? '<span class="badge badge-success">是</span>' : '<span class="badge badge-danger">否</span>'}</td>
                        <td>${user.realcash ? '<span class="badge badge-success">实盘</span>' : '<span class="badge badge-danger">模拟</span>'}</td>
                        <td>${user.parent_id || '<span class="badge badge-success">是</span>'}</td>
                        ${isSuperAdmin ? '<div class="row-actions"><span style="color: #999;">受保护的超级管理员</span></div>' : `
                            <div class="row-actions">
                                <button class="action-btn action-btn-edit" onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                    ${user.is_active ? '禁用' : '启用'}
                                </button>
                                <button class="action-btn action-btn-edit" style="display: ${user.parent_id ? 'none' : ''}" onclick="toggleSuperuser(${user.id}, ${!user.is_superuser})">
                                    ${user.is_superuser ? '取消管理员' : '设为管理员'}
                                </button>
                                <button class="action-btn action-btn-delete" onclick="confirmDelete(${user.id}, '${user.email}')">删除</button>
                            </div>
                        `}
                    `;
                    tbody.appendChild(row);

                    if (!user.parent_id) {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username || user.id;
                        parentSelect.appendChild(option);
                    }
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('userList').style.display = 'block';
            } catch (error) {
                showError(error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function toggleUserStatus(userId, newStatus) {
            try {
                await updateUser(userId, { is_active: newStatus });
                showSuccess('用户状态已更新');
                setTimeout(() => loadUsers(), 1000);
            } catch (error) {
                showError(error.message);
            }
        }

        async function toggleSuperuser(userId, newStatus) {
            try {
                await updateUser(userId, { is_superuser: newStatus });
                showSuccess('管理员权限已更新');
                setTimeout(() => loadUsers(), 1000);
            } catch (error) {
                showError(error.message);
            }
        }

        async function confirmDelete(userId, email) {
            if (confirm(`确定要删除用户 ${email} 吗？此操作不可恢复！`)) {
                try {
                    await deleteUser(userId);
                    showSuccess('用户已删除');
                    setTimeout(() => loadUsers(), 1000);
                } catch (error) {
                    showError(error.message);
                }
            }
        }

        async function createUser(event) {
            event.preventDefault();

            const email = document.getElementById('newUserEmail').value;
            const username = document.getElementById('newUserUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const is_active = document.getElementById('newUserIsActive').checked;
            const is_verified = document.getElementById('newUserIsVerified').checked;
            const is_superuser = document.getElementById('newUserIsSuperuser').checked;
            const realcash = parseInt(document.getElementById('newUserRealcash').value);
            const parent_id = parseInt(document.getElementById('newUserParent').value);

            try {
                const userData = {
                    email,
                    username,
                    password,
                    is_active,
                    is_verified,
                    is_superuser,
                    realcash
                };

                if (parent_id) {
                    userData.parent_id = parent_id;
                }

                await register(userData);

                showSuccess('用户创建成功！');
                document.getElementById('createUserForm').reset();
                document.getElementById('newUserIsActive').checked = true;
                setTimeout(() => loadUsers(), 1000);
            } catch (error) {
                showError(error.message);
            }
        }

        async function init() {
            const isAdmin = await checkAdminAccess();
            if (isAdmin) {
                await loadUsers();

                // 绑定创建用户表单
                document.getElementById('createUserForm').addEventListener('submit', createUser);
            }
        }

        init();
    </script>
</body>
</html>
